---
title: 50 听起来很恐怖的数据库幻读，到底是个什么奇葩问题？
category:
  - MySQL
date: 2023-02-27
---

<!-- more -->


**不可重复读**，就是一个事务多次查询一条数据，结果每次读到的值都不一样，这个过程中可能别的事务会修改这条数据的值，而且修改值之后事务都提交了，结果导致人家每次查到的值都不一样，都查到了提交事务修改过的值。

**脏写**就是两个事务没提交的状况下，都修改同一条数据，结果一个事务回滚了，把另外一个事务修改的值也给撤销了，所谓脏写就是两个事务没提交状态下修改同一个值。

**脏读**就是一个事务修改了一条数据的值，结果还没提交呢，另外一个事务就读到了你修改的值，然后你回滚了，人家事务再次读，就读不到了，也就是说人家事务读到了你修改之后还没提交的值，这就是脏读了。

而**不可重复读，针对的是已经提交的事务修改的值**，被你事务给读到了，你事务内多次查询，多次读到的是别的已经提交的事务修改过的值，这就导致不可重复读了。

> **幻读**

简单来说，你一个事务A，先发送一条SQL语句，里面有一个条件，要查询一批数据出来，比如`select * from table where id>10`，类似这种SQL。

然后呢，他一开始查询出来了10条数据，如下图所示。

![image-20220221134651280](https://studyimages.oss-cn-beijing.aliyuncs.com/img/mysql/34-63/202210201139370.png)

接着这个时候，别的事务B往表里插入了几条数据，而且事务B还提交了，如下图所示，此时多了几行数据出来。

<img src="https://studyimages.oss-cn-beijing.aliyuncs.com/img/mysql/34-63/202210201139371.png" alt="image-20220221134704262" />

接着事务A此时第三次查询，再次按照之前的一模一样的条件执行`select * from table where id>10`这条SQL语句，由于其他事务插入了几条数据，导致这次他查询出来了12条数据，如下图所示。

<img src="https://studyimages.oss-cn-beijing.aliyuncs.com/img/mysql/34-63/202210201139372.png" alt="image-20220221134722667" />

于是此时事务A开始怀疑自己的双眼了，为什么一模一样的SQL语句，第一次查询是10条数据，第二次查询是12条数据？难道刚才出现了幻觉？导致我刚才幻读了？这就是**幻读**这个名词的由来。

**幻读指的就是你一个事务用一样的SQL多次查询，结果每次查询都会发现查到了一些之前没看到过的数据**。

脏写、脏读、不可重复读、幻读，这些问题。都是数据库的多事务并发问题，那么为了解决多事务并发问题，数据库才设计了**事务隔离机制**、**MVCC多版本隔离机制**、**锁机制**，用一整套机制来解决多事务并发问题，接下来，我们将要深入讲解这些机制，让大家彻底能够理解数据库内部的执行原理。

> **总结**

1、**幻读** 和 **不可重复读** 很容易混淆。前者是指读到了其他事务已经新增的数据，而后者是指读到了已经提交事务的更改数据（更改或删除），为了避免这两种情况，采取的对策是不同的。**防止读取到更改数据，只需要对操作的数据添加行级锁**，阻止操作中的数据发生变化。而**防止读取到新增数据，则往往需要添加表级锁**。

2、**注意，幻读特指的是你查询到了之前查询没看到过的数据！此时就说你是幻读了（读到了其他事务已经新增的数据）。**

